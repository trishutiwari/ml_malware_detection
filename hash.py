from scapy.layers import http

def get_payload(pkt):
    """
    Fetch the everything from layer 3 and above (network layer +)

    :param pkt:
    :return:
    """
    for i in range(2):
        pkt = pkt.payload
    try:
    	return pkt.encode('utf-8')
    except Exception as e:
    	return str(pkt).encode('utf-8')


def calculate_hash(session_obj, new_session):
    """
    Function to calculate/update the hash.

    :param session_obj:
    :param new_session:
    :return:
    """
    for packet in new_session:
        session_obj[5].update(get_payload(packet))
    return session_obj

def entropy_domain_names(new_session):
    entropy = 0
    for packet in new_session:
        if not packet.haslayer(http.HTTPRequest):
            http_layer = packet.getlayer(http.HTTPRequest)
            if http_layer[Method] == "POST"
                url = http_layer[Host] + http_layer[Path]
                proc = subprocess.Popen(" {0} | ent".format(url),shell=True,stdout=subprocess.STDOUT)
                entropy +=  int(proc.stdout.read())
    return entropy
                

